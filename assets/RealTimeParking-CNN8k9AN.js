import{h as Y,r as o,o as ee,n as te,a as ne,c as u,b as a,l as z,t as v,i as F,j as O,k,F as R,m as V,f as c,_ as ae}from"./index-BS-yrSsG.js";import{L as b}from"./leaflet-Pecd1ig-.js";const oe={class:"rt-container"},ie={class:"board"},le={class:"map-board"},se={key:0,class:"board-error"},re={class:"filter"},ue={style:{position:"relative"}},ce={key:0,class:"error-message"},de={key:1,class:"autocomplete"},me=["onClick"],ve={class:"time-display"},pe={class:"time-label"},fe={class:"btn-group"},ge={class:"timer"},he={class:"timer-options"},we=["onClick"],ye={class:"timer-actions"},ke=["disabled"],be={key:0,class:"timer-display"},Se=Y({__name:"RealTimeParking",setup(Te){const I=o(""),r=o(""),d=o(""),m=o([]),S=o(12),w=o("Medium"),T=o(""),y=o([]);async function Z(){try{const t=await fetch("/api/realtime/zones");if(t.ok){const e=await t.json();y.value=e.zones,console.log("Loaded zones:",y.value.length)}}catch(t){console.error("Failed to load zones:",t)}}function B(){if(d.value="",m.value=[],!r.value.trim())return;const t=r.value.toLowerCase().trim();m.value=y.value.filter(n=>String(n.zoneNumber).toLowerCase().includes(t)||n.streetName.toLowerCase().includes(t));const e=y.value.find(n=>String(n.zoneNumber)===r.value||n.streetName.toLowerCase()===t);t.length>0&&!e&&m.value.length===0&&(d.value="Invalid zone number or street name"),console.log("validateArea called:",{input:r.value,filteredCount:m.value.length,zones:y.value.length})}function H(t){r.value=t.zoneNumber,I.value=t.zoneNumber,d.value="",m.value=[]}function q(t){return`${t.toString().padStart(2,"0")}:00`}async function U(){T.value="",await j()}function A(t){w.value=t}const N=o(null);let l=null,_=null,L=null;ee(async()=>{await Z(),r.value=I.value;const t=localStorage.getItem("parkingTimer");if(t)try{const e=JSON.parse(t),n=Date.now();e.endAt&&e.endAt>n?(g.value=e.endAt,p.value=e.selectedMinutes||30,f.value=!0,M(),i&&window.clearInterval(i),i=window.setInterval(M,250),D()):localStorage.removeItem("parkingTimer")}catch(e){console.error("Failed to restore timer:",e),localStorage.removeItem("parkingTimer")}await te(),N.value&&(l=b.map(N.value,{zoomControl:!0,scrollWheelZoom:!0}).setView([-37.8136,144.9631],13),b.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap",detectRetina:!0}).addTo(l),L=b.layerGroup().addTo(l),requestAnimationFrame(()=>{l.invalidateSize(),requestAnimationFrame(()=>l.invalidateSize())}),_=new ResizeObserver(()=>l?.invalidateSize()),_.observe(N.value),window.addEventListener("resize",P))}),ne(()=>{window.removeEventListener("resize",P),_?.disconnect(),_=null});function P(){setTimeout(()=>l?.invalidateSize(),80)}async function j(){try{if(!l)return;const t=new URLSearchParams({area:I.value,hour:String(S.value),demand:w.value});console.log("Loading spots with params:",t.toString());const e=await fetch(`/api/realtime/spots?${t.toString()}`);if(!e.ok)throw new Error(`API ${e.status}`);const n=await e.json();console.log("Received spots data:",n),G(n.spots)}catch(t){console.error("Error loading spots:",t),T.value=t?.message??"Failed to load spots"}}function G(t){if(!(!l||!L)){if(console.log("Rendering spots:",t.length,"spots"),L.clearLayers(),t.length===0){console.log("No spots to render");return}for(const e of t){console.log("Adding spot:",e.id,"at",e.lat,e.lng,"occupied:",e.occupied);const n=b.circleMarker([e.lat,e.lng],{radius:6,color:"#e74c3c",weight:1,fillOpacity:.9});e.occupied?n.bindTooltip("Occupied"):(n.setStyle({color:"#2ecc71"}),n.bindTooltip("Available")),n.addTo(L)}J(t),console.log("Finished rendering spots")}}function J(t){if(!(!l||t.length===0))try{const e=t.map(s=>s.lat),n=t.map(s=>s.lng),h=(Math.min(...e)+Math.max(...e))/2,$=(Math.min(...n)+Math.max(...n))/2,C=b.latLngBounds(t.map(s=>[s.lat,s.lng]));l.fitBounds(C,{padding:[20,20],maxZoom:16,animate:!0}),console.log("Flying to area:",h,$,"with",t.length,"spots")}catch(e){console.error("Error flying to area:",e)}}const W=[30,60,120,180],p=o(30),f=o(!1),g=o(null),x=o("00:00");let i=null;function K(){const t=p.value||30;g.value=Date.now()+t*6e4,f.value=!0,localStorage.setItem("parkingTimer",JSON.stringify({endAt:g.value,selectedMinutes:p.value})),M(),i&&window.clearInterval(i),i=window.setInterval(M,250),D(),setTimeout(()=>{E("Timer Started",`Parking timer set for ${p.value} minutes`)},100)}function Q(){i&&(window.clearInterval(i),i=null),f.value=!1,g.value=null,x.value="00:00",localStorage.removeItem("parkingTimer")}function M(){if(!g.value)return;const t=Math.max(0,g.value-Date.now());x.value=X(t),t===0&&(i&&(window.clearInterval(i),i=null),f.value=!1,E("Parking timer","Time is up. Please return to your car."))}function X(t){const e=Math.floor(t/1e3),n=Math.floor(e/3600),h=Math.floor(e%3600/60),$=e%60,C=String(h).padStart(2,"0"),s=String($).padStart(2,"0");return n>0?`${n}:${C}:${s}`:`${C}:${s}`}function D(){"Notification"in window&&Notification.permission==="default"&&Notification.requestPermission().then(t=>{console.log("Notification permission:",t)}).catch(()=>{})}function E(t,e){"Notification"in window&&(Notification.permission==="granted"?new Notification(t,{body:e}):Notification.permission==="default"?Notification.requestPermission().then(n=>{n==="granted"?new Notification(t,{body:e}):alert(`${t}: ${e}`)}):alert(`${t}: ${e}`))}return(t,e)=>(c(),u(R,null,[e[12]||(e[12]=a("div",{class:"hero"},[a("div",{class:"hero-inner"},[a("h1",null,"Real-Time Parking")])],-1)),a("div",oe,[a("section",ie,[e[7]||(e[7]=a("p",{class:"board-title"},"Live map visualisation of Real-Time availability",-1)),a("div",le,[a("div",{ref_key:"mapEl",ref:N,class:"map"},null,512),e[5]||(e[5]=a("div",{class:"map-overlay"},[a("div",{class:"map-title"},"Live map visualisation of Real-Time availability")],-1)),e[6]||(e[6]=a("div",{class:"map-footer"}," View available spots in real-time by time of day, area and current demand ",-1))]),T.value?(c(),u("div",se,v(T.value),1)):z("",!0)]),a("aside",re,[e[8]||(e[8]=a("h2",null,"Select Area",-1)),a("div",ue,[F(a("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=n=>r.value=n),onInput:B,placeholder:"Enter zone number or street name",class:k(["input-field",{invalid:d.value}])},null,34),[[O,r.value]]),d.value?(c(),u("div",ce,v(d.value),1)):z("",!0),m.value.length&&!d.value?(c(),u("div",de,[(c(!0),u(R,null,V(m.value,(n,h)=>(c(),u("div",{key:`${n.zoneNumber}-${n.streetName}-${h}`,class:"autocomplete-item",onClick:$=>H(n)},v(n.streetName)+" (Zone "+v(n.zoneNumber)+") ",9,me))),128))])):z("",!0)]),e[9]||(e[9]=a("h3",null,"Time of Day",-1)),a("div",ve,[F(a("input",{class:"range",type:"range",min:"0",max:"23","onUpdate:modelValue":e[1]||(e[1]=n=>S.value=n)},null,512),[[O,S.value,void 0,{number:!0}]]),a("span",pe,v(q(S.value)),1)]),e[10]||(e[10]=a("h3",null,"Demand Level",-1)),a("div",fe,[a("button",{class:k(["chip",{active:w.value==="High"}]),onClick:e[2]||(e[2]=n=>A("High"))},"High",2),a("button",{class:k(["chip",{active:w.value==="Medium"}]),onClick:e[3]||(e[3]=n=>A("Medium"))},"Medium",2),a("button",{class:k(["chip",{active:w.value==="Low"}]),onClick:e[4]||(e[4]=n=>A("Low"))},"Low",2)]),a("button",{class:"btn-primary",onClick:U},"Search Now"),e[11]||(e[11]=a("h3",null,"Parking Timer",-1)),a("div",ge,[a("div",he,[(c(),u(R,null,V(W,n=>a("button",{key:n,class:k(["timer-pill",{active:p.value===n}]),onClick:h=>p.value=n},v(n)+" min",11,we)),64))]),a("div",ye,[a("button",{class:"btn-primary",onClick:K},"Start Timer"),a("button",{class:"btn-outline",onClick:Q,disabled:!f.value},"Reset",8,ke)]),f.value?(c(),u("div",be,"Remaining: "+v(x.value),1)):z("",!0)])])])],64))}}),Le=ae(Se,[["__scopeId","data-v-69491136"]]);export{Le as default};
